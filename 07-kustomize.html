<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ArgoCD + Kustomize :: Kitchensink Guide</title>
    <link rel="canonical" href="https://atarazana.github.io/kitchensink-guide/07-kustomize.html">
    <link rel="prev" href="06-applicationset.html">
    <link rel="next" href="08-helm.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="./_/css/site.css">
<link rel="icon" href="./_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="./_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://atarazana.github.io/kitchensink-guide">Kitchensink Guide</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Kitchensink Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-prepare-cluster.html">1. Prepare Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#deploying-core-components">Deploying core components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#high-level-tests">High Level Tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#checking-gitea">Checking Gitea</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-setup.html">2. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#openshift">Setup OpenShift 4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#download-tutorial">Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-prepare-devspaces.html">3. Prepare Devspaces</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#create-workspace">Create Workspace</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#opening-a-terminal-window">Opening a Terminal Window</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#allow-paste-from-clipboard">Allow Paste From Clipboard</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-s2i.html">4. Deploy JBoss EAP Application with S2I</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-s2i.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-s2i.html#deploy">Deploying a JBOSS EAP 7.2 application manually</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-s2i.html#hot-redeploy">Redeploying a JBOSS EAP application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-argo.html">5. Deploy JBoss EAP Application with ArgoCD</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-argo.html#overview">Simplification, git-based automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-argo.html#deploy">Deploy Kitchensink app with ArgoCD</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-applicationset.html">6. ArgoCD + ApplicationSet</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-applicationset.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-applicationset.html#deploy">Deploy Kitchensink app with ArgoCD + ApplicationSet</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="07-kustomize.html">7. ArgoCD + Kustomize</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-helm.html">8. ArgoCD + Helm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-cicd.html">9. CI/CD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-cicd.html#deploying-cicd-pipelines">Deploying CICD Pipelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-cicd.html#create-git-secret">Create Git Secret</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-helm-kustomized.html">10. ArgoCD + Helm + Kustomize</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#deploy">Deploy Kitchensink app with ArgoCD + Kustomize + Helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#benefits">Benefits of the GitOps/ArgoCD model</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="11-pipeline-webhooks.html">11. Pipeline Webhooks</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="12-test-cicd-pipelines.html">12. Check Pipeline Webhooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-test-cicd-pipelines.html#check-kitchensink-ci-web-hook">Check Kitchensink CI Web Hook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-test-cicd-pipelines.html#check-kitchensink-cd-web-hook">Check Kitchensink CD Web Hook</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="13-end-to-end-test.html">13. End to End Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#current-status">Ⓐ Current Status</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#change-the-code">Ⓑ Change the code</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#run-ci-pipeline">Ⓒ Run CI pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#running-cd-pipeline-dev">Ⓓ Run CD pipeline (<code>dev</code>)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#running-cd-pipeline-test">Ⓔ Run CD pipeline (<code>test</code>)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="14-upgrade-jboss-version.html">14. Upgrade JBoss EAP version</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Kitchensink Guide</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Kitchensink Guide</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Kitchensink Guide</a></li>
    <li><a href="07-kustomize.html">7. ArgoCD + Kustomize</a></li>
  </ul>
</nav>
  <div style="padding: 0 0.5rem 0 0.75rem;"><a href="https://github.com/atarazana" target="_blank" rel="noopener noreferrer"> © 2023 - Atarazana</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">ArgoCD + Kustomize</h1>
<div class="sect1">
<h2 id="deploy"><a class="anchor" href="#deploy"></a>Deploy Kitchensink app with ArgoCD + Kustomize</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we are going to deploy the same application in the same way, but instead of using descriptors directly we are going to customize them for the corresponding environment (overlay) using <a href="https://kustomize.io/" target="_blank" rel="noopener">kustomize</a>.</p>
</div>
<div class="paragraph">
<p>In this case, you will deploy your application in two environments (overlays in kustomize jargon): <code>dev</code> and <code>test</code>. This two environments will map to two namespaces:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>dev</code> &#8594; <code>kustomize-dev-%USERNAME%</code></p>
</li>
<li>
<p><code>test</code> &#8594; <code>kustomize-test-%USERNAME%</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>How does <code>kustomize</code> work? In a nutshell, you give kustomize a bunch of descriptors and it will put them in a certain namespace, set labels to all the objects and patch them if necessary. Ideal to deploy an application in a given environment isn&#8217;t it?</p>
</div>
<div class="paragraph">
<p>At a lower level <code>kustomize</code> requires a <code>kustomization.yml</code> that points to the descriptors you want to deploy in a certain namespace (of course and adding labels, patching, etc.). Find below the kustomization.yml file corresponding to the <code>dev</code> environment:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
bases:
  - ../../basic <i class="conum" data-value="1"></i><b>(1)</b>
namespace: kustomize-dev-%USERNAME% <i class="conum" data-value="2"></i><b>(2)</b>
commonLabels: <i class="conum" data-value="3"></i><b>(3)</b>
  app.kubernetes.io/part-of: kitchensink-app
  app.kubernetes.io/managed-by: argocd
secretGenerator:
  - name: kitchensink-database-secret
    literals:
      - DB_HOST=events-database
      - DB_USER=luke
      - DB_PASSWORD=secret
      - DB_NAME=EVENTS
patchesJson6902:
  - target:
      group: apps.openshift.io
      version: v1
      kind: DeploymentConfig
      name: kitchensink
    path: patch/deployment_patch.yml</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Points to the folder<sup class="footnote" id="_footnote_basic-folder">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> of descriptors you used before</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Namespace to put all descriptors in</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Labels to apply to all resources</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can find the two overlays below:</p>
</div>
<div class="listingblock console-input">
<div class="title">dev</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/kitchensink-conf/src/branch/main/kustomize/dev</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="title">test</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/kitchensink-conf/src/branch/main/kustomize/test</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-app"><a class="anchor" href="#deploy-app"></a>Deploy Using Kustomize and an ApplicationSet</h2>
<div class="sectionbody">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc apply -n openshift-gitops -f -
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: kitchensink-kustomize-%USERNAME%
  namespace: openshift-gitops
  labels:
    argocd-root-app: "true"
    username: %USERNAME%
spec:
  generators: <i class="conum" data-value="1"></i><b>(1)</b>
  - list:
      elements:
      - env: dev
        ns: kustomize-dev-%USERNAME%
        desc: "Kustomize Dev"
      - env: test
        ns: kustomize-test-%USERNAME%
        desc: "Kustomize Test"
  template: <i class="conum" data-value="2"></i><b>(2)</b>
    metadata:
      name: kitchensink-kustomize-app-{{ env }}-%USERNAME%
      namespace: openshift-gitops
      labels:
        kitchensink-root-app: "true"
        username: %USERNAME%
      finalizers:
      - resources-finalizer.argocd.argoproj.io
    spec:
      destination:
        namespace: '{{ ns }}'
        name: in-cluster
      ignoreDifferences:
      - group: apps.openshift.io
        kind: DeploymentConfig
        jqPathExpressions:
          - .spec.template.spec.containers[].image
      project: default
      syncPolicy:
        automated:
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
      source:
        path: kustomize/{{ env }}
        repoURL: "https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/kitchensink-conf"
        targetRevision: main
EOF</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This generator will create two Applications for both overlays: dev and test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This template uses attributes <strong>ns</strong> and <strong>env</strong> to customize the Application object for the two overlays</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can check the deployment status in both Argo and OpenShift.</p>
</div>
<div class="paragraph">
<p><strong>Argo</strong></p>
</div>
<div class="paragraph">
<p>Open the following link to see the new Application objects you just created through the ApplicationSet in ArgoCD UI.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-url hljs" data-lang="url">https://openshift-gitops-server-openshift-gitops.apps.%BASE_SUBDOMAIN%</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-kitchensink-appset-kustomize.png" alt="Apps">
</div>
</div>
<div class="paragraph">
<p><strong>OpenShift</strong></p>
</div>
<div class="paragraph">
<p>To see the progress of deployment you should go to namespace <code>kustomize-dev-%USERNAME%</code> and namespace <code>kustomize-test-%USERNAME%</code> in the OpenShift web console or just copy the following links.</p>
</div>
<div class="listingblock console-input">
<div class="title">kustomize-dev-%USERNAME%</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-url hljs" data-lang="url">https://console-openshift-console.apps.%BASE_SUBDOMAIN%/topology/ns/kustomize-dev-%USERNAME%?view=graph</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="title">kustomize-test-%USERNAME%</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-url hljs" data-lang="url">https://console-openshift-console.apps.%BASE_SUBDOMAIN%/topology/ns/kustomize-test-%USERNAME%?view=graph</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-catch"><a class="anchor" href="#the-catch"></a>The catch</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This approach covers deploying our application in two environments using the same descriptors and adapting them by means of patches, common labels and setting the namespace as well, this is just great.</p>
</div>
<div class="paragraph">
<p>But&#8230;&#8203; What if you have to adapt the descriptors even more, different storage, different cloud vendor, &#8230;&#8203;?</p>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Go here <a href="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/kitchensink-conf/src/branch/main/basic" class="bare">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/kitchensink-conf/src/branch/main/basic</a>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="06-applicationset.html" class="query-params-link">6. ArgoCD + ApplicationSet</a></span>
  <span class="next"><a href="08-helm.html" class="query-params-link">8. ArgoCD + Helm</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
