<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CI/CD pipelines to close the circle :: Kitchensink Guide</title>
    <link rel="canonical" href="https://atarazana.github.io/kitchensink-guide/09-cicd.html">
    <link rel="prev" href="08-helm.html">
    <link rel="next" href="10-helm-kustomized.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="./_/css/site.css">
<link rel="icon" href="./_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="./_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://atarazana.github.io/kitchensink-guide">Kitchensink Guide</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Kitchensink Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-prepare-cluster.html">1. Prepare Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#deploying-core-components">Deploying core components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#high-level-tests">High Level Tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#checking-gitea">Checking Gitea</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-setup.html">2. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#openshift">Setup OpenShift 4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#download-tutorial">Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-prepare-devspaces.html">3. Prepare Devspaces</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#create-workspace">Create Workspace</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#opening-a-terminal-window">Opening a Terminal Window</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#allow-paste-from-clipboard">Allow Paste From Clipboard</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-s2i.html">4. Deploy JBoss EAP Application with S2I</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-s2i.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-s2i.html#deploy">Deploying a JBOSS EAP 7.2 application manually</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-s2i.html#hot-redeploy">Redeploying a JBOSS EAP application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-argo.html">5. Deploy JBoss EAP Application with ArgoCD</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-argo.html#overview">Simplification, git-based automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-argo.html#deploy">Deploy Kitchensink app with ArgoCD</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-applicationset.html">6. ArgoCD + ApplicationSet</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-applicationset.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-applicationset.html#deploy">Deploy Kitchensink app with ArgoCD + ApplicationSet</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-kustomize.html">7. ArgoCD + Kustomize</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-helm.html">8. ArgoCD + Helm</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-cicd.html">9. CI/CD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploying-cicd-pipelines">Deploying CICD Pipelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#create-git-secret">Create Git Secret</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-helm-kustomized.html">10. ArgoCD + Helm + Kustomize</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#deploy">Deploy Kitchensink app with ArgoCD + Kustomize + Helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#benefits">Benefits of the GitOps/ArgoCD model</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="11-pipeline-webhooks.html">11. Pipeline Webhooks</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="12-test-cicd-pipelines.html">12. Check Pipeline Webhooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-test-cicd-pipelines.html#check-kitchensink-ci-web-hook">Check Kitchensink CI Web Hook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-test-cicd-pipelines.html#check-kitchensink-cd-web-hook">Check Kitchensink CD Web Hook</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="13-end-to-end-test.html">13. End to End Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#current-status">Ⓐ Current Status</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#change-the-code">Ⓑ Change the code</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#run-ci-pipeline">Ⓒ Run CI pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#running-cd-pipeline-dev">Ⓓ Run CD pipeline (<code>dev</code>)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#running-cd-pipeline-test">Ⓔ Run CD pipeline (<code>test</code>)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="14-upgrade-jboss-version.html">14. Upgrade JBoss EAP version</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Kitchensink Guide</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Kitchensink Guide</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Kitchensink Guide</a></li>
    <li><a href="09-cicd.html">9. CI/CD Pipelines</a></li>
  </ul>
</nav>
  <div style="padding: 0 0.5rem 0 0.75rem;"><a href="https://github.com/atarazana" target="_blank" rel="noopener noreferrer"> © 2023 - Atarazana</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">CI/CD pipelines to close the circle</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter you&#8217;re going to deploy CI and CD pipelines based on <a href="https://tekton.dev/" target="_blank" rel="noopener">tekton</a> that will help to automate the processes of continuos integration and delivery. It&#8217;s made of three sections, the first one deploys an ArgoCD Application that will create not only the pipelines but all the necessary elements the other two will guide you to generate the secrets necessary to connect to the git repos and the container image registry.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It&#8217;s a best practice avoid storing secrets in a git repository even if it&#8217;s private. There are several ways to deal with secrets in this kind of scenarios but in this case we&#8217;re going to manage them manually for the sake of simplicity.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-cicd-pipelines"><a class="anchor" href="#deploying-cicd-pipelines"></a>Deploying CICD Pipelines</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to deploy another ArgoCD application, this time to deploy pipelines. Please run this command which will create an ApplicationSet to deploy our CICD pipelines.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc apply -n openshift-gitops -f -
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: kitchensink-cicd-%USERNAME%
  namespace: openshift-gitops
  labels:
    kitchensink-cicd-appset: "true"
spec:
  generators:
  - list:
      elements:
      - cluster: in-cluster
        ns: "cicd-tekton-%USERNAME%"
  template:
    metadata:
      name: kitchensink-cicd-%USERNAME%
      namespace: openshift-gitops
      labels:
        kitchensink-cicd-app: "true"
      finalizers:
      - resources-finalizer.argocd.argoproj.io
    spec:
      destination:
        namespace: '{{ ns }}'
        name: '{{ cluster }}'
      project: default
      syncPolicy:
        automated:
          selfHeal: true
      source:
        helm:
          parameters:
            - name: kitchensinkRepoUrl
              value: "https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/kitchensink"
            - name: kitchensinkRevision
              value: "main"
            - name: kitchensinkConfRepoUrl
              value: "https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/kitchensink-conf"
            - name: kitchensinkConfRevision
              value: "main"
            - name: username
              value: "%USERNAME%"
            - name: gitSslVerify
              value: "true"
            - name: cicdNamespace
              value: "cicd-tekton-%USERNAME%"
            - name: overlayDevNamespace
              value: "helm-kustomize-dev-%USERNAME%"
            - name: overlayTestNamespace
              value: "helm-kustomize-test-%USERNAME%"
            - name: containerRegistryServer
              value: myregistry-quay-quay-system.apps.%BASE_SUBDOMAIN%
            - name: containerRegistryOrg
              value: %USERNAME%
        path: cicd
        repoURL: "https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/kitchensink-conf"
        targetRevision: main
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s go to ArgoCD console and see how it&#8217;s going on. Please copy the next link and open it in a new tab.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://openshift-gitops-server-openshift-gitops.apps.%BASE_SUBDOMAIN%/applications?proj=&amp;sync=&amp;health=&amp;namespace=&amp;cluster=&amp;labels=kitchensink-cicd-app&amp;search=%USERNAME%</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-kitchensink-appset-cicd.png" alt="Apps">
</div>
</div>
<div class="paragraph">
<p>And go deeper by clicking on the <code>Application</code> object or using the next link.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://openshift-gitops-server-openshift-gitops.apps.%BASE_SUBDOMAIN%/applications/kitchensink-cicd-%USERNAME%</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-kitchensink-appset-cicd-deep.png" alt="Apps">
</div>
</div>
<div class="paragraph">
<p>You can also have a look to the pipelines created in the OpenShift web console.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://console-openshift-console.apps.%BASE_SUBDOMAIN%/dev-pipelines/ns/cicd-tekton-%USERNAME%</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-kitchensink-cicd.png" alt="Apps">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-git-secret"><a class="anchor" href="#create-git-secret"></a>Create Git Secret</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to create secrets instead of storing them in the git repo, but before we do that let’s check that ArgoCD has created the namespace for us.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the namespace is not there yet, you can check the sync status of the ArgoCD application with:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">argocd app list | grep kitchensink-cicd-%USERNAME%</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get project cicd-tekton-%USERNAME%</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see something like this:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                DISPLAY NAME   STATUS
cicd-tekton-user1                  Active</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fine, the namespace is in place, <strong>it&#8217;s time to create the git secret our pipelines will use when cloning and also while creating Pull Requests</strong> which are the fuel for the CD part of the pipelines to promote from one environment to the next.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create a PAT here, don&#8217;t worry if you created one before.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can run this command as often as needed</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">GIT_PAT=$(curl -k -s -XPOST -H "Content-Type: application/json" \
  -d '{"name":"cicd'"${RANDOM}"'","scopes": ["repo"]}' \
  -u %USERNAME%:openshift \
  <a href="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/api/v1/users/%USERNAME%/tokens" class="bare">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/api/v1/users/%USERNAME%/tokens</a> | jq -r .sha1)
echo "GIT_PAT=${GIT_PAT}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the actual secret which embeds the PAT you just created using the next command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc apply -n cicd-tekton-%USERNAME% -f -
apiVersion: v1
kind: Secret
metadata:
  name: git-pat-secret
  namespace: cicd-tekton-%USERNAME%
type: kubernetes.io/basic-auth
stringData:
  user.name: %USERNAME%
  user.email: "%USERNAME%@example.com"
  username: %USERNAME%
  password: ${GIT_PAT}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>You have to annotate the secret so that it can actually be used by the pipeline.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc annotate -n cicd-tekton-%USERNAME% secret git-pat-secret \
  "tekton.dev/git-0=https://repository-gitea-system.apps.%BASE_SUBDOMAIN%"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that the secret is in place and annotated you can proceed to the next chapter.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="08-helm.html" class="query-params-link">8. ArgoCD + Helm</a></span>
  <span class="next"><a href="10-helm-kustomized.html" class="query-params-link">10. ArgoCD + Helm + Kustomize</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
