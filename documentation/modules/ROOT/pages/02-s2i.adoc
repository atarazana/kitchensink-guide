= Deploy JBoss EAP Application with S2I
include::_attributes.adoc[]

[#overview]
== Overview

https://github.com/openshift/source-to-image[Source-to-Image (S2I)] is a framework that makes it easy to write images that take application source code as an input and produce a new image that runs the assembled application as output.

The main advantage of using S2I for building reproducible container images is the ease of use for developers.

.Source code deployment process
image::s2i.png[] 


[#deploy]
== Deploying a JBOSS EAP 7.2 application manually

Let's deploy the Kitchensink stack !

. First of all, create the project that will host the application:
+
[.console-input]
[source, bash,subs="+macros,+attributes"]
----
oc new-project s2i-{username}
----
+
. Deploy the PostgreSQL database for the kitchensink app:
+
[.console-input]
[source, bash,subs="+macros,+attributes"]
----
oc new-app --name=kitchensink-db \
 -e POSTGRESQL_USER=luke \
 -e POSTGRESQL_PASSWORD=secret \
 -e POSTGRESQL_DATABASE=kitchensink centos/postgresql-10-centos7 \
 --as-deployment-config=false

oc label deployment/kitchensink-db app.kubernetes.io/part-of=kitchensink-app --overwrite=true && \
oc label deployment/kitchensink-db app.openshift.io/runtime=postgresql --overwrite=true
----
+
[NOTE]
====
The ``oc label`` commands adds decoration to our deployment (used for the #Topology view#):

- ``app.openshift.io/runtime``: Icon displayed in the node
- ``app.kubernetes.io/part-of``: App grouping
====
+
. Deploy the kitchensink app:
+
[.console-input]
[source, bash,subs="+macros,+attributes"]
----
oc new-app --template=eap72-basic-s2i \
-p APPLICATION_NAME=kitchensink \
-p MAVEN_ARGS_APPEND="-Dcom.redhat.xpaas.repo.jbossorg" \
-p SOURCE_REPOSITORY_URL=https://github.com/atarazana/kitchensink \
-p SOURCE_REPOSITORY_REF=main \
-p CONTEXT_DIR=.
----
+
[NOTE]
====
In order to deploy the Kitchensink app, we use a template, ``eap72-basic-s2i``.

A template describes a set of objects that can be parameterized and processed to produce a list of objects for creation by OpenShift Container Platform. A template can be processed to create anything you have permission to create within a project, for example services, build configurations, and deployment configurations. A template can also define a set of labels to apply to every object defined in the template.

You can create a list of objects from a template using the CLI or, if a template has been uploaded to your project or the global template library, using the web console.
====
+
. Adjust the context of the application and add _decoration_ (labels and annotation):
+
[.console-input]
[source, bash,subs="+macros,+attributes"]
----
oc set env dc/kitchensink DB_HOST=kitchensink-db DB_PORT=5432 DB_NAME=kitchensink DB_USERNAME=luke DB_PASSWORD=secret && \
oc set probe dc/kitchensink --readiness --initial-delay-seconds=90 --failure-threshold=5 && \
oc set probe dc/kitchensink --liveness --initial-delay-seconds=90 --failure-threshold=5

oc label dc/kitchensink app.kubernetes.io/part-of=kitchensink-app --overwrite=true && \
oc label dc/kitchensink app.openshift.io/runtime=jboss --overwrite=true

oc annotate dc/kitchensink \
 app.openshift.io/connects-to='[{"apiVersion":"apps/v1","kind":"Deployment","name":"kitchensink-db"}]' \
 --overwrite=true
----
+
[NOTE]
====
The ``app.openshift.io/connects-to`` annotation is used to connect the nodes.
====

[#redeploy]
== Redeploying a JBOSS EAP application

A quick way to test _minor_ changes in our application, and always in a #development environment#, we can redeploy our app as follows:

[.console-input]
[source, bash,subs="+macros,+attributes"]
----
oc project s2i-{username}

POD_NAME=$(oc get pod -l application=kitchensink -o json | jq -r .items[0].metadata.name)

mvn package -Popenshift && oc cp ./target/ROOT.war ${POD_NAME}:/deployments/ROOT.war
----