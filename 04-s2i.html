<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploy JBoss EAP Application with S2I :: Kitchensink Guide</title>
    <link rel="canonical" href="https://atarazana.github.io/kitchensink-guide/04-s2i.html">
    <link rel="prev" href="03-prepare-devspaces.html">
    <link rel="next" href="05-argo.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="./_/css/site.css">
<link rel="icon" href="./_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="./_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://atarazana.github.io/kitchensink-guide">Kitchensink Guide</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Kitchensink Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-prepare-cluster.html">1. Prepare Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#deploying-core-components">Deploying core components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#high-level-tests">High Level Tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#checking-gitea">Checking Gitea</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-setup.html">2. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#openshift">Setup OpenShift 4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#download-tutorial">Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-prepare-devspaces.html">3. Prepare Devspaces</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#create-workspace">Create Workspace</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#opening-a-terminal-window">Opening a Terminal Window</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#allow-paste-from-clipboard">Allow Paste From Clipboard</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-s2i.html">4. Deploy JBoss EAP Application with S2I</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploy">Deploying a JBOSS EAP 7.2 application manually</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#redeploy">Redeploying a JBOSS EAP application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-argo.html">5. Deploy JBoss EAP Application with ArgoCD</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-argo.html#overview">Simplification, git-based automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-argo.html#deploy">Deploy Kitchensink app with ArgoCD</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-applicationset.html">6. ArgoCD + ApplicationSet</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-applicationset.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-applicationset.html#deploy">Deploy Kitchensink app with ArgoCD + ApplicationSet</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-kustomize.html">7. ArgoCD + Kustomize</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-helm.html">8. ArgoCD + Helm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-cicd.html">9. CI/CD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-cicd.html#deploying-cicd-pipelines">Deploying CICD Pipelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-cicd.html#create-git-secret">Create Git Secret</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-helm-kustomized.html">10. ArgoCD + Helm + Kustomize</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#deploy">Deploy Kitchensink app with ArgoCD + Kustomize + Helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#benefits">Benefits of the GitOps/ArgoCD model</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="11-pipeline-webhooks.html">11. Pipeline Webhooks</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="12-test-cicd-pipelines.html">12. Check Pipeline Webhooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-test-cicd-pipelines.html#check-kitchensink-ci-web-hook">Check Kitchensink CI Web Hook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-test-cicd-pipelines.html#check-kitchensink-cd-web-hook">Check Kitchensink CD Web Hook</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="13-end-to-end-test.html">13. End to End Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#current-status">Ⓐ Current Status</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#change-the-code">Ⓑ Change the code</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#run-ci-pipeline">Ⓒ Run CI pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#running-cd-pipeline-dev">Ⓓ Run CD pipeline (<code>dev</code>)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#running-cd-pipeline-test">Ⓔ Run CD pipeline (<code>test</code>)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="14-upgrade-jboss-version.html">14. Upgrade JBoss EAP version</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Kitchensink Guide</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Kitchensink Guide</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Kitchensink Guide</a></li>
    <li><a href="04-s2i.html">4. Deploy JBoss EAP Application with S2I</a></li>
  </ul>
</nav>
  <div style="padding: 0 0.5rem 0 0.75rem;"><a href="https://github.com/atarazana" target="_blank" rel="noopener noreferrer"> © 2023 - Atarazana</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Deploy JBoss EAP Application with S2I</h1>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/openshift/source-to-image" target="_blank" rel="noopener">Source-to-Image (S2I)</a> is a framework that makes it easy to build images starting from your source code. In reality S2I can start from your source code, a file (usually a binary), a bunch of files or a Dockerfile.</p>
</div>
<div class="paragraph">
<p>Here we&#8217;re going to concentrate on the first strategy, building our application image starting from the code in a git repository.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <strong>main advantages</strong> of using S2I for building images are the <strong>ease of use</strong> for developers and being a <strong>repeatable process</strong>.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/s2i.png" alt="s2i">
</div>
<div class="title">Figure 1. Source code deployment process</div>
</div>
<div class="sect2">
<h3 id="but-how-does-it-work"><a class="anchor" href="#but-how-does-it-work"></a>But How Does It Work?</h3>
<div class="paragraph">
<p>Well as you can see in the previous image building an image that runs your code comprises three phases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Build App:</strong> Compiling code, this is language specific and can imply downloading dependencies, compiling, linking, etc. All the tools needed should be present at the builder image. The output of this phase is a binary file or a jar, along with libraries if necessary, etc.</p>
</li>
<li>
<p><strong>Build Image:</strong> In this phase we put the output of the previous phase in a known location inside the image so that it can be run later as a container. The output of this phase is an image based on the builder image or a specific image with the minimum required components for running and your application.</p>
</li>
<li>
<p><strong>Deploy:</strong> Finally we need to deploy our image to a kubernetes cluster and this means referring to our application image from a <strong>Deployment</strong>, <strong>DeploymentConfig</strong>, <strong>StatefulSet</strong>, <strong>DaemonSet</strong>, <strong>Job</strong>, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s go a bit deeper with the explanation, in order to build your application you will need a builder image designed according to the S2I framework. In general, you will use a supported image by Red Hat, it can be for Java, Python, .Net, etc. go <a href="https://docs.openshift.com/container-platform/4.12/openshift_images/using_images/using-s21-images.html" target="_blank" rel="noopener">here</a> but if you need or want to create your own builder image you can go <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.12/html/images/creating-images#images-create-s2i-scripts_create-images" target="_blank" rel="noopener">here</a> to learn all you need to do it.</p>
</div>
<div class="paragraph">
<p>In a nutshell a builder image is an image that includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>All the tools you need to compile</strong>, download dependencies, etc. for a given programming language.</p>
</li>
<li>
<p><strong>Source-to-image scripts:</strong> You can write source-to-image (S2I) scripts in any programming language, as long as the scripts are executable inside the builder image. S2I supports multiple options providing <code>assemble/run/save-artifacts</code> scripts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The two most important scripts are <code>assemble</code> and <code>run</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><code>assemble</code></strong> &#8594; The assemble script builds the application artifacts from a source and places them into appropriate directories inside the image. This script is required.</p>
</li>
<li>
<p><strong><code>run</code></strong> &#8594;  The run script executes your application. This script is required.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="being-more-specific"><a class="anchor" href="#being-more-specific"></a>Being More Specific</h3>
<div class="paragraph">
<p>Ok, for now the explanation applies to any language/framework, but this lab has to do with a specific language, Java, and a specific runtime to deploy it on, JBoss EAP, so let&#8217;s go a bit deeper.</p>
</div>
<div class="paragraph">
<p>First, <strong>you will be using a specific builder image</strong> for JBoss EAP instead of the plain Java builder image. This image contains maven, JDK and JBoss EAP 7.2 Specifically in this lab you will use this image:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong><code>registry.redhat.io/jboss-eap-7/eap72-openshift:latest</code></strong></p>
</div>
</div>
</div>
<div class="paragraph">
<p>Second, the <code>assemble</code> and <code>run</code> scripts are there to help you avoiding substituting the <code>standalone.xml</code> file that comes with the image. Don&#8217;t take this wrong, you still can substitute it but it&#8217;s usually a better practice to adapt the file during the <code>assemble</code> and <code>run</code> stages using well defined procedures.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using the procedures explained in this guide there are more chances that you will build the image for your application across minor upgrades of JBoss EAP without making any changes to the configuration of S2I.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="assemble-script"><a class="anchor" href="#assemble-script"></a>Assemble Script</h3>
<div class="paragraph">
<p>In short, the <code>assemble</code> script:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Compiles and generates a <code>WAR/JAR/EAR</code> file using <code>maven</code></p>
</li>
<li>
<p>Copies the output of the previous step to the JBoss deployments path (/deployments)</p>
</li>
<li>
<p>Checks if <code>CUSTOM_INSTALL_DIRECTORIES</code> environment variable has been defined. The content of this environment variable should be a list of source directories.</p>
</li>
<li>
<p>If <code>CUSTOM_INSTALL_DIRECTORIES</code> is defined, then <strong>for each of those directories look for a file called <code>install.sh</code></strong></p>
<div class="ulist">
<ul>
<li>
<p>If there is an <code>install.sh</code> script executes it</p>
</li>
<li>
<p>Else the following artifact directories will be copied to their respective destinations in the built image:</p>
<div class="ulist">
<ul>
<li>
<p><strong>modules/</strong>* copied to <strong>$JBOSS_HOME/modules/system/layers/openshift</strong></p>
</li>
<li>
<p><strong>configuration/</strong>* copied to <strong>$JBOSS_HOME/standalone/configuration</strong></p>
</li>
<li>
<p><strong>deployments/</strong>* copied to <strong>$JBOSS_HOME/standalone/deployments</strong></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here you are an <code>install.sh</code> script example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

injected_dir=$1
source /usr/local/s2i/install-common.sh
install_deployments ${injected_dir}/injected-deployments.war
install_modules ${injected_dir}/modules
configure_drivers ${injected_dir}/drivers.env</code></pre>
</div>
</div>
<div class="paragraph">
<p>In our guide you can find an <code>install.sh</code> script at <code>extensions/install.sh</code>. Have a look to the contents below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">#!/bin/bash
echo "&gt;&gt;&gt;&gt;&gt;&gt;&gt; Running install.sh &lt;&lt;&lt;&lt;&lt;&lt;"
echo ${injected_dir}
if [ "${SCRIPT_DEBUG}" = "true" ] ; then
    set -x
    echo "Script debugging is enabled, allowing bash commands and their arguments to be printed as they are executed"
fi

injected_dir=$1
source /usr/local/s2i/install-common.sh <i class="conum" data-value="1"></i><b>(1)</b>
configure_drivers ${injected_dir}/driver-oracle.env <i class="conum" data-value="2"></i><b>(2)</b>
# configure_drivers ${injected_dir}/driver-postgresql.env <i class="conum" data-value="3"></i><b>(3)</b>

# copy any needed files into the target build.
cp -rf ${injected_dir} $JBOSS_HOME/extensions <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Load functions like <code>configure_drivers</code>, <code>install_deployments</code> or <code>install_modules</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Install Oracle driver which is not installed by default. It&#8217;s not used in this guide but as an example variation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In JBoss EAP 7.2 PostgreSQL driver is already installed but this is not the case in JBOSS EAP 7.4 as you will see in the upcoming chapter about upgrading JBoss.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Our <code>extensions</code> folder is installed by copying it to <code>$JBOSS_HOME/extensions</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="run-script"><a class="anchor" href="#run-script"></a>Run Script</h3>
<div class="paragraph">
<p>Once at runtime, the <code>run</code> script comes into play and it will look for execution hooks which are executed, if available, from <code>$JBOSS_HOME/bin/launch/configure.sh</code>.</p>
</div>
<div class="paragraph">
<p>Configuration occurs over three basic phases: preConfigure, configure and postConfigure.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>preConfigure:</strong> invoked before any configuration takes place.  Use this to manipulate the environment prior to configuration.</p>
</li>
<li>
<p><strong>configure:</strong> invoked to configure based on the execution environment.</p>
</li>
<li>
<p><strong>postConfigure:</strong> invoked after all configuration has been completed.</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>In addition to the execution environment, users may specify additional configuration details through environment scripts specified through the ENV_FILES variable.  The processing of env files is similar to the process for the execution environment, with the addition of a prepareEnv method, which is used to clean the environment before processing the env contributed by a file.  This is to help ensure that duplicate configurations are not created when processing env files.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In our guide you can find a postConfigure script at <code>extensions/postconfigure.sh</code>. You can also find the content the file copied below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>postconfigure.sh</code> executes the <code>extensions/setup.cli</code> JBoss CLI script to set the JBoss up for <code>kitchensink</code>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">#!/usr/bin/env bash
echo "&gt;&gt;&gt;&gt;&gt;&gt; Executing postconfigure.sh &lt;&lt;&lt;&lt;&lt;&lt;&lt;"

if [ "${SCRIPT_DEBUG}" = "true" ] ; then
    set -x
    echo "Script debugging is enabled, allowing bash commands and their arguments to be printed as they are executed"
fi

echo "&gt;&gt;&gt;&gt;&gt;&gt; Executing setup.cli &lt;&lt;&lt;&lt;&lt;&lt;&lt;"
$JBOSS_HOME/bin/jboss-cli.sh --file=$JBOSS_HOME/extensions/setup.cli <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can find this script below</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look to the <code>extensions/setup.cli</code> script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">embed-server --std-out=echo --server-config=standalone-openshift.xml <i class="conum" data-value="1"></i><b>(1)</b>

/subsystem=datasources/data-source=kitchensink:add( \ <i class="conum" data-value="2"></i><b>(2)</b>
  jndi-name="java:jboss/jdbc/kitchensink", \
  connection-url="jdbc:postgresql://${env.DB_HOST}:${env.DB_PORT:5432}/${env.DB_NAME:kitchensink}", \ <i class="conum" data-value="3"></i><b>(3)</b>
  driver-name=postgresql, \ <i class="conum" data-value="4"></i><b>(4)</b>
  user-name=${env.DB_USERNAME},password=${env.DB_PASSWORD}, \ <i class="conum" data-value="5"></i><b>(5)</b>
  validate-on-match=true, \
  valid-connection-checker-class-name="org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLValidConnectionChecker",exception-sorter-class-name="org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLExceptionSorter" \
)

if (outcome == success) of /subsystem=datasources/jdbc-driver=mysql:read-attribute(name=driver-name)
    # Remove Driver
    /subsystem=datasources/jdbc-driver=mysql:remove
end-if

quit</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Script runs on an embed server and results are applied to <code>standalone-openshift.xml</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Adding a new data source</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Connection string</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Driver</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Credentials</td>
</tr>
</table>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>You can find more information about building images for JBoss EAP using S2I <a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html/getting_started_with_jboss_eap_for_openshift_container_platform/configuring_eap_openshift_image#s2i_modules_drivers_deployments" target="_blank" rel="noopener">here</a>.</p>
</div>
</blockquote>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a>Let&#8217;s get started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Everything we do in this section requires that you have fulfilled the <a href="#01-setup.adoc#prerequisite" class="xref unresolved">prerequisites</a> section and you&#8217;re logged in your OpenShift cluster.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Log in <strong>as normal user</strong>, <span class="underline">not as a cluster admin</span>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So if not already logged in, please do it now.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you&#8217;re using <code>DevSpaces</code> or the <code>web-terminal</code>, you don&#8217;t need to log in, you&#8217;re already logged in, try this command <code>oc whoami</code> and check that the response is: %USERNAME%.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc login -u %USERNAME% -p %PASSWORD% --server=https://api.%BASE_SUBDOMAIN%:6443</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy"><a class="anchor" href="#deploy"></a>Deploying a JBOSS EAP 7.2 application manually</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once <code>BuildConfigs</code> are pointing to the right repo we can go on.</p>
</div>
<div class="paragraph">
<p><strong>Let&#8217;s deploy the Kitchensink manually using S2I!</strong></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This template deploys our application using a <code>DeploymentConfig</code> instead of the kubernetes <code>Deployment</code> object, starting in chapter <code>ArgoCD + Helm</code> you will see that we&#8217;ve moved from <code>DeploymentConfig</code> to <code>Deployment</code>. In any case S2I has nothing to do with the type of deployment descriptor we choose!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First of all, create the project that will host the application:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc new-project s2i-%USERNAME%</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Please open the next link to watch the progress of the chapter.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">https://console-openshift-console.apps.%BASE_SUBDOMAIN%/topology/ns/s2i-%USERNAME%?view=graph</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Deploy the PostgreSQL database for the kitchensink app:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc new-app --name=kitchensink-db \
 -e POSTGRESQL_USER=luke \
 -e POSTGRESQL_PASSWORD=secret \
 -e POSTGRESQL_DATABASE=kitchensink centos/postgresql-10-centos7 \
 --as-deployment-config=false

oc label deployment/kitchensink-db app.kubernetes.io/part-of=kitchensink-app --overwrite=true &amp;&amp; \
oc label deployment/kitchensink-db app.openshift.io/runtime=postgresql --overwrite=true</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>oc label</code> commands adds decoration to our deployment (used for the <mark>Topology view</mark>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>app.openshift.io/runtime</code>: Icon displayed in the node</p>
</li>
<li>
<p><code>app.kubernetes.io/part-of</code>: App grouping</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Deploy the kitchensink app:</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Run <code>oc get template -n openshift | grep eap</code> to find other JBoss EAP related templates
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc new-app --template=eap72-basic-s2i \
-p APPLICATION_NAME=kitchensink \
-p MAVEN_ARGS_APPEND="-Dcom.redhat.xpaas.repo.jbossorg" \
-p SOURCE_REPOSITORY_URL="https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/kitchensink" \
-p SOURCE_REPOSITORY_REF=main \
-p CONTEXT_DIR=. &amp;&amp; \
oc rollout pause dc/kitchensink</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to deploy the Kitchensink app, we use a template, <code>eap72-basic-s2i</code>.</p>
</div>
<div class="paragraph">
<p>A template describes a set of objects that can be parameterized and processed to produce a list of objects for creation by OpenShift Container Platform. A template can be processed to create anything you have permission to create within a project, for example services, build configurations, and deployment configurations. A template can also define a set of labels to apply to every object defined in the template.</p>
</div>
<div class="paragraph">
<p>You can create a list of objects from a template using the CLI or, if a template has been uploaded to your project or the global template library, using the web console.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Adjust the context of the application and add <em>decoration</em> (labels and annotation):</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc set env dc/kitchensink DB_HOST=kitchensink-db DB_PORT=5432 DB_NAME=kitchensink DB_USERNAME=luke DB_PASSWORD=secret &amp;&amp; \
oc set probe dc/kitchensink --readiness --initial-delay-seconds=90 --failure-threshold=5 &amp;&amp; \
oc set probe dc/kitchensink --liveness --initial-delay-seconds=90 --failure-threshold=5 &amp;&amp; \
oc rollout resume dc/kitchensink

oc label dc/kitchensink app.kubernetes.io/part-of=kitchensink-app --overwrite=true &amp;&amp; \
oc label dc/kitchensink app.openshift.io/runtime=jboss --overwrite=true

oc annotate dc/kitchensink \
 app.openshift.io/connects-to='[{"apiVersion":"apps/v1","kind":"Deployment","name":"kitchensink-db"}]' \
 --overwrite=true</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>app.openshift.io/connects-to</code> annotation is used to connect the nodes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="checking-build-config"><a class="anchor" href="#checking-build-config"></a>Checking BuildConfig</h3>
<div class="paragraph">
<p>Open the next link and click on the <code>in progress</code> icon to see the log of the building process.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://console-openshift-console.apps.%BASE_SUBDOMAIN%/topology/ns/s2i-%USERNAME%?view=graph</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/s2i-01.png" alt="Build Config link">
</div>
</div>
<div class="paragraph">
<p>Eventually you will see a trace like this:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>&#8658; <code>&gt;&gt;&gt;&gt;&gt;&gt;&gt; Running install.sh &lt;&lt;&lt;&lt;&lt;&lt;</code></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This is a sign that the S2I building process has detected our script to prepare the image as desired. We already talked about the <code>install.sh</code> script above in this chapter. Remember that S2I <code>assemble</code> script will look for an environment variable <code>CUSTOM_INSTALL_DIRECTORIES</code> which in its turn points to the <code>extensions</code> folder where we have an <code>install.sh</code> which sets drivers, and copies all the needed files to run <strong>kitchensink</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/s2i-02.png" alt="Build Log">
</div>
</div>
</div>
<div class="sect2">
<h3 id="checking-the-application"><a class="anchor" href="#checking-the-application"></a>Checking the Application</h3>
<div class="paragraph">
<p>After the building process has finished the image is pushed and the <code>DeploymentConfig</code> object is updated accordingly to use the new image. If you go the <code>Topology</code> view you should see this.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/s2i-04.png" alt="Deployed">
</div>
</div>
<div class="paragraph">
<p>You have seen in the traces while building the container image that the <code>assemble</code> scripts is executed and in its turn runs our <code>install.sh</code> script. Now let&#8217;s have a look at the traces of the image while running. In this case it is the <code>run</code> script which is executed and if everything worked as expected out <code>postconfigure.sh</code> script should have been run <em>before</em> JBoss actually runs.</p>
</div>
<div class="paragraph">
<p>Run this command to have a look at the pod logs to find the expected trace including <code>postconfigure.sh</code>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc logs dc/kitchensink -n s2i-%USERNAME% | grep -A5 -B5 -e "postconfigure.sh"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Time to check if our application works as expected. Go back to the <code>Topology View</code>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://console-openshift-console.apps.%BASE_SUBDOMAIN%/topology/ns/s2i-%USERNAME%?view=graph</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, please click on the route icon.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/s2i-05.png" alt="Checking">
</div>
</div>
<div class="paragraph">
<p>You should see something like this.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/s2i-06.png" alt="Result">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="hot-redeploy"><a class="anchor" href="#hot-redeploy"></a>Hot redeploying a JBOSS EAP application</h2>
<div class="sectionbody">
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You have to wait until the application has been deployed, in the previous item, in order to redeploy it!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s explore a quick way to test <em>minor</em> changes in our application. In this case you will package your JBoss EAP application locally and later you will use <code>oc cp</code> to copy the WAR file directly to the deployment folder of JBoss EAP already running in OCP.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use this way of deployment only in a <mark>development environment</mark>, <mark><strong>NEVER</strong> in productive environments</mark>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s make a change in our application, open file <code>$TUTORIAL_HOME/src/main/webapp/index.xhtml</code> (the Kitchensink code repo) and go to line 27 approx. and make a change. For instance change this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&lt;div&gt;
    &lt;p&gt;You have successfully deployed the JBoss Application in OpenShift&lt;/p&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&lt;div&gt;
    &lt;p&gt;You have successfully deployed the JBoss Application in OpenShift !!!&lt;/p&gt;
&lt;/div</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then please, run these commands:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project s2i-%USERNAME%

POD_NAME=$(oc get pod -l application=kitchensink -o json | jq -r .items[0].metadata.name)
echo "POD_NAME=${POD_NAME}"

mvn package -Popenshift</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally let&#8217;s replace <code>ROOT.war</code> inside the pod we just located:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>oc cp</code> command doesn&#8217;t show a progress bar and usually is quite fast, if there are no errors no messages will be surfaced, just proceed with the tests.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc cp ./target/ROOT.war ${POD_NAME}:/deployments/ROOT.war</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open this link to check if the change is already applied.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Take into account that for a short period of time the app is being replaced and you could get a 404 error if you&#8217;re quick enough.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-url hljs" data-lang="url">https://kitchensink-s2i-%USERNAME%.apps.%BASE_SUBDOMAIN%/index.jsf</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/s2i-03.png" alt="After hot reload">
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03-prepare-devspaces.html" class="query-params-link">3. Prepare Devspaces</a></span>
  <span class="next"><a href="05-argo.html" class="query-params-link">5. Deploy JBoss EAP Application with ArgoCD</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
