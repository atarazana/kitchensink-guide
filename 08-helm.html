<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ArgoCD + Kustomize :: Kitchensink Guide</title>
    <link rel="canonical" href="https://atarazana.github.io/kitchensink-guide/08-helm.html">
    <link rel="prev" href="07-kustomize.html">
    <link rel="next" href="09-cicd.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="./_/css/site.css">
<link rel="icon" href="./_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="./_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://atarazana.github.io/kitchensink-guide">Kitchensink Guide</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Kitchensink Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-prepare-cluster.html">1. Prepare Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#deploying-core-components">Deploying core components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#high-level-tests">High Level Tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-prepare-cluster.html#checking-gitea">Checking Gitea</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-setup.html">2. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#openshift">Setup OpenShift 4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup.html#download-tutorial">Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-prepare-devspaces.html">3. Prepare Devspaces</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#create-workspace">Create Workspace</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#opening-a-terminal-window">Opening a Terminal Window</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-prepare-devspaces.html#allow-paste-from-clipboard">Allow Paste From Clipboard</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-s2i.html">4. Deploy JBoss EAP Application with S2I</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-s2i.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-s2i.html#deploy">Deploying a JBOSS EAP 7.2 application manually</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-s2i.html#hot-redeploy">Redeploying a JBOSS EAP application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-argo.html">5. Deploy JBoss EAP Application with ArgoCD</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-argo.html#overview">Simplification, git-based automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-argo.html#deploy">Deploy Kitchensink app with ArgoCD</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-applicationset.html">6. ArgoCD + ApplicationSet</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-applicationset.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-applicationset.html#deploy">Deploy Kitchensink app with ArgoCD + ApplicationSet</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-kustomize.html">7. ArgoCD + Kustomize</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="08-helm.html">8. ArgoCD + Helm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-cicd.html">9. CI/CD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-cicd.html#deploying-cicd-pipelines">Deploying CICD Pipelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-cicd.html#create-git-secret">Create Git Secret</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-helm-kustomized.html">10. ArgoCD + Helm + Kustomize</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#deploy">Deploy Kitchensink app with ArgoCD + Kustomize + Helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-helm-kustomized.html#benefits">Benefits of the GitOps/ArgoCD model</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="11-pipeline-webhooks.html">11. Pipeline Webhooks</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="12-test-cicd-pipelines.html">12. Check Pipeline Webhooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-test-cicd-pipelines.html#check-kitchensink-ci-web-hook">Check Kitchensink CI Web Hook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-test-cicd-pipelines.html#check-kitchensink-cd-web-hook">Check Kitchensink CD Web Hook</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="13-end-to-end-test.html">13. End to End Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#current-status">Ⓐ Current Status</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#change-the-code">Ⓑ Change the code</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#run-ci-pipeline">Ⓒ Run CI pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#running-cd-pipeline-dev">Ⓓ Run CD pipeline (<code>dev</code>)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-end-to-end-test.html#running-cd-pipeline-test">Ⓔ Run CD pipeline (<code>test</code>)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="14-upgrade-jboss-version.html">14. Upgrade JBoss EAP version</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Kitchensink Guide</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Kitchensink Guide</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Kitchensink Guide</a></li>
    <li><a href="08-helm.html">8. ArgoCD + Helm</a></li>
  </ul>
</nav>
  <div style="padding: 0 0.5rem 0 0.75rem;"><a href="https://github.com/atarazana" target="_blank" rel="noopener noreferrer"> © 2023 - Atarazana</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">ArgoCD + Kustomize</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In the previous chapter you used <a href="https://kustomize.io/" target="_blank" rel="noopener">kustomize</a> to deploy your application to two different environments (or overlays). But there was a catch: What if you have to adapt the descriptors even more, different storage, different cloud vendor, &#8230;&#8203;?</p>
</div>
<div class="paragraph">
<p>In this case <a href="https://helm.sh/" target="_blank" rel="noopener">helm</a> could fit the bill. With <strong>helm</strong> you can use templates to adapt the descriptor to almost anything. It&#8217;s true that with <strong>helm</strong> you can install and upgrade, but you can use it only if you want to use the template engine to generate the descriptors the way you need. This is exactly what Argo CD will do for you it will use the command <code>helm template</code> to generate kubernetes descriptors starting from a git repository.</p>
</div>
<div class="paragraph">
<p>Please have a look at the next link:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/kitchensink-conf/src/branch/main/advanced/helm_base/templates</code></pre>
</div>
</div>
<div class="paragraph">
<p>There you will find basically the same descriptors you should be already used to, like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>kitchensink-deployment.yaml</strong> &#8658; deployment descriptor of kitchensink</p>
</li>
<li>
<p><strong>kitchensink-db-deployment.yaml</strong> &#8658; deployment descriptor of the kitchensink database</p>
</li>
<li>
<p><strong>kitchensink-bc.yaml</strong> &#8658; <code>BuildConfig</code> in charge of building our application image using S2I</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The only difference is that labels, namespace, etc. are not set all in the same way, <strong>there&#8217;s a greater degree of freedom because</strong> the <strong>helm template language is richer than the kustomize yaml directives</strong>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy"><a class="anchor" href="#deploy"></a>Deploy Kitchensink app with ArgoCD + Helm</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we are going to deploy the same application in the same way, but instead of using overlays we will use templates with <code>helm</code>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc apply -n openshift-gitops -f -
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kitchensink-helm-app-%USERNAME%
  namespace: openshift-gitops
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  labels:
    kitchensink-root-app: 'true'
    helm: 'true'
    username: %USERNAME%
spec:
  destination:
    name: in-cluster
    namespace: helm-%USERNAME%
  ignoreDifferences:
    - group: apps
      jqPathExpressions:
        - '.spec.template.spec.containers[].image'
      kind: Deployment
  project: default
  source:
    helm:
      parameters:
        - name: debug
          value: 'true'
        - name: baseNamespace
          value: 'helm-%USERNAME%'
    path: advanced/helm_base
    repoURL: "https://repository-gitea-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/kitchensink-conf"
    targetRevision: main
  syncPolicy:
    automated:
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
EOF</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">helm</div>
<div class="paragraph">
<p>Parameters that allow us to adjust descriptor templates to particular needs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">...
    helm:
      parameters:
        - name: baseNamespace
          value: demo-6
...</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Check the deployment status in both Argo and OpenShift.</p>
</div>
<div class="paragraph">
<p><strong>Argo</strong></p>
</div>
<div class="paragraph">
<p>Open the following link to see the new Application objects you just created through the ApplicationSet in ArgoCD UI.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-url hljs" data-lang="url">https://openshift-gitops-server-openshift-gitops.apps.%BASE_SUBDOMAIN%/applications?labels=username%253D%USERNAME%%2Chelm%253Dtrue</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-kitchensink-helm.png" alt="Apps">
</div>
</div>
<div class="paragraph">
<p><strong>OpenShift</strong></p>
</div>
<div class="paragraph">
<p>To see the progress of deployment you should go to namespace <code>helm-%USERNAME%</code> in the OpenShift web console or just copy the following link.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-url hljs" data-lang="url">https://console-openshift-console.apps.%BASE_SUBDOMAIN%/topology/ns/helm-%USERNAME%?view=graph</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-catch"><a class="anchor" href="#the-catch"></a>The catch</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This approach allows you to adjust descriptors with a greater degree of freedom at the expense of making it difficult to deploy in different environments which kustomize can do easily&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Wouldn&#8217;t if be perfect to use helm to generate the base descriptors for kustomize to put them into the right namespace with the right common labels, etc?</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="07-kustomize.html" class="query-params-link">7. ArgoCD + Kustomize</a></span>
  <span class="next"><a href="09-cicd.html" class="query-params-link">9. CI/CD Pipelines</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
